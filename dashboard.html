<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreSense | AI Career Coach</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #00d2ff; --secondary: #9d50bb; --bg: #06061a; --glass: rgba(255, 255, 255, 0.04); --border: rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: white; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        nav { width: 250px; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); border-right: 1px solid var(--border); padding: 30px 20px; display: flex; flex-direction: column; }
        
        .nav-brand { 
            font-size: 1.6rem; 
            font-weight: 800; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 40px; 
        }

        .nav-item { padding: 12px 18px; margin: 5px 0; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.5); transition: 0.3s; font-size: 0.95rem; }
        .nav-item.active { background: rgba(0, 210, 255, 0.1); color: var(--primary); border: 1px solid rgba(0, 210, 255, 0.2); }
        .nav-item:hover:not(.active) { color: white; background: rgba(255,255,255,0.05); }

        /* Main Grid Layout */
        main { flex: 1; padding: 30px; display: grid; grid-template-columns: 350px 1fr; grid-template-rows: auto auto 1fr; gap: 25px; overflow-y: auto; }

        .glass-card { background: var(--glass); backdrop-filter: blur(30px); border-radius: 24px; border: 1px solid var(--border); padding: 30px; position: relative; display: flex; flex-direction: column; }
        
        /* Left Column */
        .control-panel { grid-row: span 2; } 
        .input-group { margin-bottom: 25px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.7); }
        input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; height: 6px; }

        .status-badge { font-size: 3rem; font-weight: 900; color: #00ff88; text-align: center; margin: 20px 0; text-shadow: 0 0 30px rgba(0,255,136,0.3); }
        .btn-action { width: 100%; padding: 16px; border-radius: 14px; background: linear-gradient(45deg, var(--primary), var(--secondary)); border: none; color: white; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.3s; font-size: 1rem; }
        .btn-action:hover { transform: scale(1.02); box-shadow: 0 10px 25px rgba(0, 210, 255, 0.2); }

        /* Right Column - Big Charts */
        .chart-section { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .history-section { grid-column: span 2; min-height: 250px; }

        h2 { font-size: 1.1rem; color: var(--primary); margin-bottom: 20px; letter-spacing: 1px; }

        /* New AI Section Style */
        .ai-roadmap {
            background: rgba(0,0,0,0.3);
            border-left: 4px solid var(--secondary);
            padding: 20px;
            margin-top: 15px;
            border-radius: 0 10px 10px 0;
            font-size: 0.9rem;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
        }
        .ai-roadmap ul { margin-left: 20px; margin-top: 10px; }
        .ai-roadmap li { margin-bottom: 5px; }

        /* Dropdown Style */
        select {
            width: 100%; padding: 12px; border-radius: 12px; 
            background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border);
            margin-top: 5px; cursor: pointer; font-size: 0.9rem;
        }
        select:focus { outline: none; border-color: var(--primary); }
        option { background: #06061a; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-brand">ScoreSense</div>
        
        <div class="nav-item" style="cursor: default; opacity: 1; background: transparent;">
            <label style="font-size: 0.75rem; color: #aaa; display: block; margin-bottom: 8px; letter-spacing: 1px;">TARGET GOAL</label>
            <select id="exam-select">
                <option value="College Semesters">College Semesters</option>
                <option value="JEE Main">JEE Main (Engineering)</option>
                <option value="NEET">NEET (Medical)</option>
                <option value="GATE">GATE (Higher Ed)</option>
                <option value="UPSC CSE">UPSC (Civil Services)</option>
                <option value="GRE">GRE (Study Abroad)</option>
                <option value="CAT">CAT (MBA)</option>
            </select>
        </div>

        <div class="nav-item active">Dashboard</div>
        <div class="nav-item" onclick="location.href='/profile'">My Profile</div>
        <div class="nav-item" onclick="downloadReport()">Download Report</div>
        <div style="margin-top: auto;" class="nav-item" onclick="location.href='/'">Logout</div>
    </nav>

    <main>
        <div class="glass-card control-panel">
            <h2>Live Prediction Control</h2>
            
            <div class="status-badge" id="status-text">PASS</div>
            <p style="text-align: center; opacity: 0.6; margin-bottom: 30px;">Model Confidence: <span id="conf-val">85%</span></p>

            <div class="input-group"><div class="label-row"><span>Attendance</span><span id="att-val">75%</span></div><input type="range" id="input-att" min="0" max="100" value="75" oninput="liveUpdate()"></div>
            <div class="input-group"><div class="label-row"><span>Weekly Study</span><span id="study-val">10h</span></div><input type="range" id="input-study" min="0" max="40" value="10" oninput="liveUpdate()"></div>
            <div class="input-group"><div class="label-row"><span>Previous Marks</span><span id="marks-val">65</span></div><input type="range" id="input-marks" min="0" max="100" value="65" oninput="liveUpdate()"></div>
            
            <button class="btn-action" onclick="runPrediction()">Run Deep Analysis</button>
            
            <div style="margin-top: 30px; text-align: center;">
                <p style="font-size: 0.8rem; opacity: 0.6;">CURRENT GRIT SCORE</p>
                <h1 style="color: var(--primary); font-size: 2.5rem;">72%</h1>
            </div>
        </div>

        <div class="glass-card" style="grid-column: span 1;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>âœ¨ Gemini Career Coach</h2>
                <button class="btn-action" style="width: auto; padding: 10px 20px; margin-top: 0; font-size: 0.85rem;" onclick="getGeminiAdvice()">Generate Roadmap</button>
            </div>
            <div id="gemini-response" class="ai-roadmap">
                Select a competitive exam from the sidebar and click "Generate Roadmap" to get a personalized strategy from Google Gemini AI.
            </div>
        </div>

        <div class="glass-card" style="grid-column: span 1; height: 350px;">
            <div style="display:flex; justify-content:space-between;">
                <h2>Skills Mapping</h2>
                <span style="font-size:0.8rem; opacity:0.5;">Interactive Radar View</span>
            </div>
            <div style="flex:1; position: relative; width: 100%;">
                <canvas id="radarChart"></canvas>
            </div>
        </div>

        <div class="glass-card history-section">
            <h2>Progress History</h2>
            <div style="flex:1; position: relative; width: 100%;">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </main>

    <div id="pdf-template" style="display:none; padding:40px; background:#06061a; color:white;">
        <h1 style="color:#00d2ff; border-bottom:2px solid #9d50bb;">ScoreSense Career Report</h1>
        <p><strong>Student:</strong> <span id="pdf-user"></span></p>
        <p><strong>Target Exam:</strong> <span id="pdf-exam"></span></p>
        <hr style="margin:20px 0; border-color:#333;">
        <h3>AI Analysis</h3>
        <p>Prediction: <span id="pdf-result" style="font-weight:bold;"></span></p>
        <div style="background:#111; padding:15px; border-left:4px solid #00d2ff; margin-top:10px;">
            <strong>Gemini Strategy:</strong>
            <div id="pdf-advice" style="font-size:0.9rem;"></div>
        </div>
        <br><br>
        <p style="font-size:0.8rem; opacity:0.5;">Generated by ScoreSense AI</p>
    </div>

    <script>
        let radar, historyChart;
        const user = localStorage.getItem('scoreSense_user') || "Student";

        window.onload = function() {
            // Radar Chart
            const ctx1 = document.getElementById('radarChart').getContext('2d');
            radar = new Chart(ctx1, {
                type: 'radar',
                data: {
                    labels: ['Att', 'Study', 'Marks', 'Focus', 'Logic'],
                    datasets: [{
                        label: 'Current Metrics',
                        data: [75, 40, 65, 70, 60],
                        backgroundColor: 'rgba(0, 210, 255, 0.2)',
                        borderColor: '#00d2ff',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: { maintainAspectRatio: false, scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });

            // History Chart
            const ctx2 = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3'],
                    datasets: [{
                        label: 'Confidence Score (%)',
                        data: [65, 72, 85],
                        borderColor: '#9d50bb',
                        backgroundColor: 'rgba(157, 80, 187, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        };

        function liveUpdate() {
            const att = document.getElementById('input-att').value;
            const study = document.getElementById('input-study').value;
            const marks = document.getElementById('input-marks').value;
            
            document.getElementById('att-val').innerText = att + "%";
            document.getElementById('study-val').innerText = study + "h";
            document.getElementById('marks-val').innerText = marks;

            const score = (att * 0.4) + (study * 4) + (marks * 0.2);
            const isPass = score > 65;
            document.getElementById('status-text').innerText = isPass ? "PASS" : "AT RISK";
            document.getElementById('status-text').style.color = isPass ? "#00ff88" : "#ff4444";
            document.getElementById('conf-val').innerText = Math.min(Math.round(score + 10), 99) + "%";
            
            radar.data.datasets[0].data = [att, study*2.5, marks, 70, 80];
            radar.update('none');
        }

        async function runPrediction() {
            const btn = document.querySelector('button[onclick="runPrediction()"]');
            btn.innerText = "Analyzing...";
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        attendance: document.getElementById('input-att').value, 
                        study_hours: document.getElementById('input-study').value, 
                        marks: document.getElementById('input-marks').value 
                    })
                });
                const res = await response.json();
                
                // Update History
                historyChart.data.labels.push('New Scan');
                historyChart.data.datasets[0].data.push(parseInt(res.confidence));
                historyChart.update();
                
                btn.innerText = "Run Deep Analysis";
            } catch (e) { btn.innerText = "Run Deep Analysis"; }
        }

        // NEW: GEMINI API FUNCTION
        async function getGeminiAdvice() {
            const btn = document.querySelector('button[onclick="getGeminiAdvice()"]');
            const output = document.getElementById('gemini-response');
            const exam = document.getElementById('exam-select').value;
            const hours = document.getElementById('input-study').value;

            btn.innerText = "Consulting Gemini...";
            output.innerHTML = "<span style='color:#00d2ff'>Connecting to Google AI Neural Net...</span>";

            try {
                const response = await fetch('/ask_gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exam: exam, study_hours: hours })
                });
                const data = await response.json();
                
                // Use Markdown-like HTML formatting from Gemini
                output.innerHTML = data.advice; 
                btn.innerText = "Regenerate Roadmap";
            } catch (e) {
                output.innerText = "Error: Could not reach Google AI. Please check API Key.";
                btn.innerText = "Try Again";
            }
        }

        function downloadReport() {
            document.getElementById('pdf-user').innerText = user;
            document.getElementById('pdf-exam').innerText = document.getElementById('exam-select').value;
            document.getElementById('pdf-result').innerText = document.getElementById('status-text').innerText;
            document.getElementById('pdf-advice').innerHTML = document.getElementById('gemini-response').innerHTML;

            const element = document.getElementById('pdf-template');
            element.style.display = 'block';
            html2pdf().from(element).save().then(() => element.style.display = 'none');
        }
    </script>
</body>
</html>