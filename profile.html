<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreSense | Profile Hub</title>
    <style>
        :root { --primary: #00d2ff; --secondary: #9d50bb; --bg: #06061a; --glass: rgba(255, 255, 255, 0.04); --border: rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: white; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        nav { width: 250px; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); border-right: 1px solid var(--border); padding: 30px 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-brand { font-size: 1.6rem; font-weight: 800; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; }
        .nav-item { padding: 12px 18px; margin: 5px 0; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.5); transition: 0.3s; font-size: 0.95rem; }
        .nav-item.active { background: rgba(0, 210, 255, 0.1); color: var(--primary); border: 1px solid rgba(0, 210, 255, 0.2); }
        .nav-item:hover:not(.active) { color: white; background: rgba(255,255,255,0.05); }

        /* --- MAIN LAYOUT --- */
        main { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 25px;
            align-items: start;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- LEFT: IDENTITY --- */
        .identity-card { text-align: center; align-items: center; position: sticky; top: 0; }
        .img-wrapper { width: 120px; height: 120px; border-radius: 50%; padding: 4px; background: linear-gradient(45deg, var(--primary), var(--secondary)); margin-bottom: 10px; position: relative; }
        .profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid #06061a; background: #111; }
        .user-name { font-size: 1.4rem; font-weight: 700; color: white; margin-bottom: 5px; }
        .user-role { font-size: 0.85rem; color: var(--primary); opacity: 0.8; background: rgba(0, 210, 255, 0.1); padding: 5px 12px; border-radius: 20px; display: inline-block; }

        /* --- CENTER: FORM STYLES --- */
        .input-group { margin-bottom: 15px; }
        label { font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-left: 5px; margin-bottom: 5px; display: block; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: 0.3s;
        }
        
        /* --- VIEW ONLY MODE (Minimal Border) --- */
        .read-only input, .read-only select, .read-only textarea {
            background: rgba(255, 255, 255, 0.02); /* Very subtle background */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Minimal Border */
            color: rgba(255,255,255,0.7);
            pointer-events: none; /* Disable clicking */
        }
        .read-only input::placeholder { color: transparent; }
        
        /* --- EDIT MODE (Highlighted) --- */
        .edit-mode input, .edit-mode select, .edit-mode textarea {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--primary);
            color: white;
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.1);
        }

        .action-btn {
            background: var(--primary);
            color: #000; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 210, 255, 0.2); }
        .btn-cancel { background: transparent; color: #aaa; border: 1px solid #555; display: none; margin-top: 10px; }

        /* --- RIGHT: LOCKED ACHIEVEMENTS --- */
        .achievement-list { list-style: none; text-align: left; }
        
        .achievement-item { 
            display: flex; align-items: center; gap: 15px; padding: 15px; 
            border-bottom: 1px solid var(--border); font-size: 0.9rem; 
            position: relative; transition: 0.3s;
        }
        
        /* LOCKED STATE */
        .achievement-item.locked { opacity: 0.4; filter: grayscale(1); }
        .achievement-item.locked::after {
            content: "üîí"; 
            position: absolute; right: 15px; font-size: 1.2rem;
        }
        
        /* UNLOCKED STATE */
        .achievement-item.unlocked { 
            opacity: 1; filter: grayscale(0); 
            background: linear-gradient(90deg, rgba(0,210,255,0.1), transparent);
            border-left: 3px solid var(--primary);
        }

        .icon { font-size: 1.5rem; }

    </style>
</head>
<body>

    <nav>
        <div class="nav-brand">ScoreSense</div>
        <div class="nav-item" onclick="location.href='/dashboard'">Dashboard</div>
        <div class="nav-item active">My Profile</div>
        <div style="margin-top: auto;" class="nav-item" onclick="location.href='/'">Logout</div>
    </nav>

    <main>
        
        <div class="glass-card identity-card">
            <div class="img-wrapper">
                <img src="" id="profile-pic" class="profile-pic">
            </div>
            <input type="file" id="file-input" hidden accept="image/*" onchange="previewImage()">

            <div class="user-name" id="display-name">Student Name</div>
            <div class="user-role">ScoreSense User</div>
        </div>

        <div class="glass-card form-section read-only" id="profile-form">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px;">
                <h2 style="border:none; margin:0; padding:0; color: var(--primary); font-size: 1.1rem;">Academic Profile</h2>
                <div style="font-size:0.8rem; color:#aaa;" id="mode-label">View Only</div>
            </div>
            
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="inp-name" placeholder="Not set">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group">
                    <label>Current CGPA</label>
                    <input type="text" id="inp-cgpa" placeholder="0.0">
                </div>
                <div class="input-group">
                    <label>Active Backlogs</label>
                    <select id="inp-backlogs">
                        <option value="0">None</option>
                        <option value="1">1 Backlog</option>
                        <option value="2">2 Backlogs</option>
                        <option value="3+">3+ Backlogs</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>Technical Skills</label>
                <input type="text" id="inp-skills" placeholder="e.g. Python, Java, React">
            </div>

            <div class="input-group">
                <label>Dream Company</label>
                <input type="text" id="inp-company" placeholder="e.g. Google, Microsoft">
            </div>

            <div class="input-group">
                <label>Phone Number</label>
                <input type="text" id="inp-phone" placeholder="Not set">
            </div>

            <div class="input-group">
                <label>Bio / Goals</label>
                <textarea id="inp-bio" rows="3" placeholder="Not set"></textarea>
            </div>

            <button class="action-btn" id="main-btn" onclick="toggleEditMode()">‚úèÔ∏è Edit Profile</button>
            <button class="action-btn btn-cancel" id="cancel-btn" onclick="cancelEdit()">Cancel</button>
        </div>

        <div class="glass-card">
            <h2 style="font-size: 1.1rem; color: var(--primary); margin-bottom: 10px;">Badges & Achievements</h2>
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:15px;">Complete your profile to unlock badges.</p>

            <ul class="achievement-list">
                <li class="achievement-item locked" id="badge-scholar">
                    <span class="icon">üéì</span>
                    <div>
                        <strong>Scholar</strong>
                        <div style="font-size:0.75rem; opacity:0.6;">CGPA above 8.0</div>
                    </div>
                </li>
                
                <li class="achievement-item locked" id="badge-techie">
                    <span class="icon">üíª</span>
                    <div>
                        <strong>Tech Stack</strong>
                        <div style="font-size:0.75rem; opacity:0.6;">Added Technical Skills</div>
                    </div>
                </li>

                <li class="achievement-item locked" id="badge-vision">
                    <span class="icon">üöÄ</span>
                    <div>
                        <strong>Visionary</strong>
                        <div style="font-size:0.75rem; opacity:0.6;">Set a Dream Company</div>
                    </div>
                </li>
            </ul>
        </div>

    </main>

    <script>
        const user = localStorage.getItem('scoreSense_user') || "User";
        let currentBase64 = "";
        let isEditing = false;
        let originalData = {}; // To restore on cancel

        window.onload = function() {
            document.getElementById('display-name').innerText = user;
            document.getElementById('profile-pic').src = `https://ui-avatars.com/api/?name=${user}&background=0D8ABC&color=fff&size=150`;
            loadData();
        };

        // --- 1. TOGGLE EDIT/VIEW MODE ---
        function toggleEditMode() {
            const form = document.getElementById('profile-form');
            const btn = document.getElementById('main-btn');
            const cancel = document.getElementById('cancel-btn');
            const label = document.getElementById('mode-label');
            const fileInput = document.getElementById('file-input');

            if (!isEditing) {
                // SWITCH TO EDIT
                isEditing = true;
                form.classList.remove('read-only');
                form.classList.add('edit-mode');
                btn.innerText = "üíæ Save Changes";
                btn.style.background = "#00C851"; // Green for save
                cancel.style.display = "block";
                label.innerText = "Editing...";
                
                // Allow clicking photo to upload only in edit mode
                document.querySelector('.img-wrapper').onclick = () => fileInput.click();
                document.querySelector('.img-wrapper').style.cursor = "pointer";
                
                // Backup data in case of cancel
                originalData = {
                    phone: document.getElementById('inp-phone').value,
                    cgpa: document.getElementById('inp-cgpa').value,
                    backlogs: document.getElementById('inp-backlogs').value,
                    skills: document.getElementById('inp-skills').value,
                    company: document.getElementById('inp-company').value,
                    bio: document.getElementById('inp-bio').value
                };
            } else {
                // SAVE ACTION
                saveProfile();
            }
        }

        function cancelEdit() {
            isEditing = false;
            const form = document.getElementById('profile-form');
            const btn = document.getElementById('main-btn');
            const cancel = document.getElementById('cancel-btn');
            const label = document.getElementById('mode-label');

            form.classList.add('read-only');
            form.classList.remove('edit-mode');
            btn.innerText = "‚úèÔ∏è Edit Profile";
            btn.style.background = "#00d2ff"; // Reset Blue
            cancel.style.display = "none";
            label.innerText = "View Only";
            document.querySelector('.img-wrapper').onclick = null;
            document.querySelector('.img-wrapper').style.cursor = "default";
            
            // Restore original data
            document.getElementById('inp-phone').value = originalData.phone;
            document.getElementById('inp-cgpa').value = originalData.cgpa;
            document.getElementById('inp-backlogs').value = originalData.backlogs;
            document.getElementById('inp-skills').value = originalData.skills;
            document.getElementById('inp-company').value = originalData.company;
            document.getElementById('inp-bio').value = originalData.bio;
        }

        function previewImage() {
            const file = document.getElementById('file-input').files[0];
            const reader = new FileReader();
            reader.onloadend = function() {
                currentBase64 = reader.result;
                document.getElementById('profile-pic').src = currentBase64;
            }
            if (file) reader.readAsDataURL(file);
        }

        // --- 2. SAVE TO DATABASE ---
        async function saveProfile() {
            const btn = document.getElementById('main-btn');
            btn.innerText = "Saving...";
            
            const payload = {
                username: user,
                phone: document.getElementById('inp-phone').value,
                cgpa: document.getElementById('inp-cgpa').value,
                backlogs: document.getElementById('inp-backlogs').value,
                skills: document.getElementById('inp-skills').value,
                dream_company: document.getElementById('inp-company').value,
                bio: document.getElementById('inp-bio').value,
                profile_pic: currentBase64 || document.getElementById('profile-pic').src
            };
            
            const realName = document.getElementById('inp-name').value;
            if(realName) localStorage.setItem('scoreSense_realname', realName);

            try {
                await fetch('/save_full_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Switch back to View Mode
                isEditing = false;
                const form = document.getElementById('profile-form');
                const cancel = document.getElementById('cancel-btn');
                const label = document.getElementById('mode-label');
                
                form.classList.add('read-only');
                form.classList.remove('edit-mode');
                btn.innerText = "‚úèÔ∏è Edit Profile";
                btn.style.background = "#00d2ff"; 
                cancel.style.display = "none";
                label.innerText = "View Only";

                // Refresh Badges
                checkAchievements();

            } catch (e) { btn.innerText = "Error Saving"; }
        }

        // --- 3. LOAD DATA ---
        async function loadData() {
            try {
                const response = await fetch(`/get_data/${user}`);
                const data = await response.json();

                if (data.found) {
                    document.getElementById('inp-phone').value = data.phone || "";
                    document.getElementById('inp-cgpa').value = data.cgpa || "";
                    document.getElementById('inp-backlogs').value = data.backlogs || "0";
                    document.getElementById('inp-skills').value = data.skills || "";
                    document.getElementById('inp-company').value = data.dream_company || "";
                    document.getElementById('inp-bio').value = data.bio || "";
                    
                    if (data.profile_pic && data.profile_pic.length > 50) {
                        document.getElementById('profile-pic').src = data.profile_pic;
                        currentBase64 = data.profile_pic;
                    }
                    
                    const realName = localStorage.getItem('scoreSense_realname');
                    if(realName) {
                        document.getElementById('inp-name').value = realName;
                        document.getElementById('display-name').innerText = realName;
                    }
                }
                checkAchievements();
            } catch (e) { }
        }

        // --- 4. GAMIFICATION LOGIC ---
        function checkAchievements() {
            const cgpa = parseFloat(document.getElementById('inp-cgpa').value) || 0;
            const skills = document.getElementById('inp-skills').value;
            const company = document.getElementById('inp-company').value;

            // Unlock Scholar
            if (cgpa >= 8.0) unlockBadge('badge-scholar');
            else lockBadge('badge-scholar');

            // Unlock Techie
            if (skills.length > 3) unlockBadge('badge-techie');
            else lockBadge('badge-techie');

            // Unlock Visionary
            if (company.length > 2) unlockBadge('badge-vision');
            else lockBadge('badge-vision');
        }

        function unlockBadge(id) {
            const badge = document.getElementById(id);
            badge.classList.remove('locked');
            badge.classList.add('unlocked');
        }
        function lockBadge(id) {
            const badge = document.getElementById(id);
            badge.classList.add('locked');
            badge.classList.remove('unlocked');
        }
    </script>
</body>
</html>
